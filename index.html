<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skydive Finder</title>
<style>
  body {
    margin: 0;
    background: transparent;
    font-family: "Segoe UI", sans-serif;
  }

  #skydiveButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 16px;
    cursor: grab;
    z-index: 9999;
    transition: background 0.3s, transform 0.2s ease-in-out;
  }

  #skydiveButton:hover {
    background: rgba(0,0,0,0.85);
    transform: scale(1.05);
  }
</style>
</head>
<body>

<button id="skydiveButton">Nearest Skydive</button>

<script>
  // --- Skydive Locations ---
  const skydiveLocations = [
    { name: "LSIA", x: -1583.657, y: -3180.656 },
    { name: "Higgins Heli Tours", x: -760.006, y: -1514.055 },
    { name: "Cayo Perico", x: 4525.786, y: -4536.526 },
    { name: "McKenzie Airport", x: 2157.815, y: 4782.25 },
    { name: "Zancudo", x: -2264.329, y: 3278.454 },
    { name: "Roxwood Airport", x: -3066.467, y: 7393.38 }
  ];

  let playerPos = { x: 0, y: 0, z: 0 };
  let lastRequestId = null;

  // --- Send request to getData (like Morfik45's apps do) ---
  function requestPlayerData() {
    lastRequestId = Date.now().toString();
    console.log("üì§ Sending getData request...");
    window.parent.postMessage({ type: "getData", requestId: lastRequestId }, "*");
  }

  // --- Handle responses from the game ---
  window.addEventListener("message", (event) => {
    const data = event.data;
    if (!data) return;

    // Match Morfik's callback pattern: the game responds with the same requestId
    if (data.type === "getData" && data.requestId === lastRequestId) {
      if (data.player && data.player.pos) {
        playerPos = data.player.pos;
        console.log("‚úÖ Player position received:", playerPos);
      } else if (data.pos) {
        playerPos = data.pos;
        console.log("‚úÖ Player position (alt format):", playerPos);
      } else {
        console.warn("‚ö†Ô∏è getData response missing position:", data);
      }
    }
  });

  // --- Find nearest skydive location ---
  function getNearestSkydive() {
    let nearest = null;
    let minDist = Infinity;
    for (const loc of skydiveLocations) {
      const dx = loc.x - playerPos.x;
      const dy = loc.y - playerPos.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < minDist) {
        minDist = dist;
        nearest = loc;
      }
    }
    return nearest;
  }

  // --- Send waypoint to game ---
  function setWaypoint(x, y) {
    console.log(`üéØ Setting waypoint to ${x}, ${y}`);
    window.parent.postMessage({ type: "setWaypoint", x, y }, "*");

    // Optional: Show notification above minimap
    window.parent.postMessage(
      { type: "notify", message: `üìç Waypoint set to nearest Skydive` },
      "*"
    );
  }

  // --- Main action ---
  function handleSetNearest() {
    requestPlayerData();

    setTimeout(() => {
      const nearest = getNearestSkydive();
      if (nearest) {
        setWaypoint(nearest.x, nearest.y);
        console.log(`‚úÖ Nearest skydive set: ${nearest.name}`);
      } else {
        console.warn("‚ö†Ô∏è Could not find nearest skydive ‚Äî no player position.");
      }
    }, 500); // small delay for getData response
  }

  // --- Button click + F6 hotkey ---
  const button = document.getElementById("skydiveButton");
  button.addEventListener("click", handleSetNearest);

  window.addEventListener("keydown", (e) => {
    if (e.code === "F6") {
      console.log("‚å®Ô∏è F6 pressed");
      handleSetNearest();
    }
  });

  // --- Smooth draggable button ---
  let isDragging = false, offsetX = 0, offsetY = 0;

  button.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - button.offsetLeft;
    offsetY = e.clientY - button.offsetTop;
    button.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", (e) => {
    if (isDragging) {
      button.style.left = (e.clientX - offsetX) + "px";
      button.style.top = (e.clientY - offsetY) + "px";
      button.style.right = "auto";
      button.style.bottom = "auto";
    }
  });

  document.addEventListener("mouseup", () => {
    if (isDragging) {
      isDragging = false;
      button.style.cursor = "grab";
      localStorage.setItem("skydiveButtonPos", JSON.stringify({
        left: button.style.left,
        top: button.style.top
      }));
    }
  });

  // --- Restore saved button position ---
  window.addEventListener("load", () => {
    const saved = localStorage.getItem("skydiveButtonPos");
    if (saved) {
      const pos = JSON.parse(saved);
      button.style.left = pos.left;
      button.style.top = pos.top;
      button.style.right = "auto";
      button.style.bottom = "auto";
    }
  });
</script>
</body>
</html>
