<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tycoon Skydive Finder</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: white;
      padding: 20px;
      text-align: center;
    }
    button {
      background: #00b86b;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    input {
      padding: 8px;
      border-radius: 6px;
      border: none;
      width: 200px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>🪂 Tycoon Skydive Finder</h2>
  <p>Find and set a waypoint to your nearest skydive location!</p>

  <div id="setup">
    <p>Enter your <b>VRPid</b>:</p>
    <input type="text" id="vrpid" placeholder="e.g. 12345"><br>
    <button onclick="start()">Start</button>
  </div>

  <div id="result" style="display:none;">
    <h3 id="status">Finding nearest skydive...</h3>
    <button onclick="findNearest()">🎯 Find Again</button>
  </div>

  <script>
    const SKYDIVES = [
      { name: "Mount Chiliad", x: -500, y: 5000 },
      { name: "Los Santos Airport", x: -1000, y: -2000 },
      { name: "Vinewood Hills", x: 800, y: 1200 }
      // add real coords later
    ];

    async function getServer(vrpid) {
      const res = await fetch("https://cdn.tycoon.community/servers.json");
      const servers = await res.json();
      for (const [key, server] of Object.entries(servers)) {
        if (server.players?.some(p => p.vrp_id == vrpid)) {
          return server.endpoint;
        }
      }
      throw new Error("Player not found on any server.");
    }

    async function getPosition(serverUrl, apiKey) {
      const res = await fetch(`${serverUrl}/status/map/positions.json`, {
        headers: { "X-Tycoon-Key": apiKey }
      });
      return await res.json();
    }

    function distance(a, b) {
      return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
    }

    async function findNearest() {
      try {
        const apiKey = localStorage.getItem("tycoonApiKey");
        const serverUrl = localStorage.getItem("serverUrl");
        const vrpid = localStorage.getItem("vrpid");

        const data = await getPosition(serverUrl, apiKey);
        const player = data.players.find(p => p.vrp_id == vrpid);
        if (!player) throw new Error("Player not found in map data.");

        const current = { x: player.pos_x, y: player.pos_y };
        const nearest = SKYDIVES.reduce((a, b) =>
          distance(current, a) < distance(current, b) ? a : b
        );

        document.getElementById("status").innerText =
          `Nearest: ${nearest.name} (${nearest.x.toFixed(0)}, ${nearest.y.toFixed(0)})`;

        if (typeof setWaypoint === "function") {
          setWaypoint(nearest.x, nearest.y);
          document.getElementById("status").innerText += "\n✅ Waypoint set!";
        } else {
          document.getElementById("status").innerText += "\n❗ Copy manually.";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ " + err.message;
      }
    }

    async function start() {
      const vrpid = document.getElementById("vrpid").value.trim();
      if (!vrpid) return alert("Enter your VRPid first.");

      let apiKey = localStorage.getItem("tycoonApiKey");
      if (!apiKey) apiKey = prompt("Enter your Tycoon API Key:");
      if (!apiKey) return alert("API key is required.");

      localStorage.setItem("vrpid", vrpid);
      localStorage.setItem("tycoonApiKey", apiKey);

      try {
        const serverUrl = await getServer(vrpid);
        localStorage.setItem("serverUrl", serverUrl);

        document.getElementById("setup").style.display = "none";
        document.getElementById("result").style.display = "block";

        findNearest();
      } catch (err) {
        alert("Error: " + err.message);
      }
    }
  </script>
</body>
</html>
