<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Skydive Finder</title>
<style>
  body {
    margin: 0;
    background: transparent;
    font-family: "Segoe UI", sans-serif;
  }

  #skydiveButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 16px;
    cursor: grab;
    z-index: 9999;
    transition: background 0.3s, transform 0.2s ease-in-out;
  }

  #skydiveButton:hover {
    background: rgba(0, 0, 0, 0.85);
    transform: scale(1.05);
  }
</style>
</head>
<body>

<button id="skydiveButton">Set Nearest Skydive</button>

<script>
  const skydiveLocations = [
    { name: "LSIA", x: -1583.657, y: -3180.656 },
    { name: "Higgins Heli Tours", x: -760.006, y: -1514.055 },
    { name: "Cayo Perico", x: 4525.786, y: -4536.526 },
    { name: "McKenzie Airport", x: 2157.815, y: 4782.25 },
    { name: "Zancudo", x: -2264.329, y: 3278.454 },
    { name: "Roxwood Airport", x: -3066.467, y: 7393.38 }
  ];

  let playerPos = { x: 0, y: 0, z: 0 };

  // Request player position explicitly (with a unique id)
  function requestPlayerPosition() {
    const requestId = Date.now().toString();
    console.log("Requesting player position via getData...");
    window.parent.postMessage(
      {
        type: "getData",
        requestId,
      },
      "*"
    );
  }

  // Listen for messages from the game
  window.addEventListener("message", (event) => {
    console.log("📩 Message received:", event.data);

    if (!event.data) return;

    // Case 1: Game sends back player data structure
    if (event.data.type === "getData" && event.data.player && event.data.player.pos) {
      playerPos = event.data.player.pos;
      console.log("✅ Player position received from game:", playerPos);
    }

    // Case 2: Some servers just send { pos: {x,y,z} }
    if (event.data.pos) {
      playerPos = event.data.pos;
      console.log("✅ Player position received (alt format):", playerPos);
    }
  });

  // Function to get the nearest skydive
  function getNearestSkydive() {
    let nearest = null;
    let minDist = Infinity;
    for (let loc of skydiveLocations) {
      const dx = loc.x - playerPos.x;
      const dy = loc.y - playerPos.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < minDist) {
        minDist = dist;
        nearest = loc;
      }
    }
    return nearest;
  }

  // Function to set waypoint in-game
  function setWaypoint(x, y) {
    console.log(`🎯 Setting waypoint to X:${x}, Y:${y}`);
    window.parent.postMessage({ type: "setWaypoint", x, y }, "*");
  }

  // Button logic
  const button = document.getElementById("skydiveButton");
  button.addEventListener("click", () => {
    requestPlayerPosition(); // Always ask for fresh player data first
    setTimeout(() => {
      const nearest = getNearestSkydive();
      if (nearest) {
        setWaypoint(nearest.x, nearest.y);
        console.log(`✅ Waypoint set to nearest: ${nearest.name}`);
      } else {
        console.warn("⚠️ No player position detected yet.");
      }
    }, 500);
  });

  // F6 Keybind
  window.addEventListener("keydown", (e) => {
    if (e.code === "F6") {
      console.log("⌨️ F6 pressed — requesting player data...");
      requestPlayerPosition();
      setTimeout(() => {
        const nearest = getNearestSkydive();
        if (nearest) {
          setWaypoint(nearest.x, nearest.y);
          console.log(`✅ (F6) Waypoint set to nearest: ${nearest.name}`);
        } else {
          console.warn("⚠️ No player position detected yet.");
        }
      }, 500);
    }
  });

  // Smooth draggable button with saved position
  let isDragging = false, offsetX, offsetY;
  button.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - button.offsetLeft;
    offsetY = e.clientY - button.offsetTop;
    button.style.cursor = "grabbing";
  });
  document.addEventListener("mousemove", (e) => {
    if (isDragging) {
      button.style.left = (e.clientX - offsetX) + "px";
      button.style.top = (e.clientY - offsetY) + "px";
      button.style.right = "auto";
      button.style.bottom = "auto";
    }
  });
  document.addEventListener("mouseup", () => {
    if (isDragging) {
      isDragging = false;
      button.style.cursor = "grab";
      localStorage.setItem("skydiveButtonPos", JSON.stringify({
        left: button.style.left,
        top: button.style.top
      }));
    }
  });
  window.addEventListener("load", () => {
    const saved = localStorage.getItem("skydiveButtonPos");
    if (saved) {
      const pos = JSON.parse(saved);
      button.style.left = pos.left;
      button.style.top = pos.top;
      button.style.right = "auto";
      button.style.bottom = "auto";
    }
  });
</script>

</body>
</html>
