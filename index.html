<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skydive Widget</title>
<style>
  body { margin:0; background:transparent; font-family:Segoe UI, sans-serif; }
  #widget {
    position:fixed; bottom:20px; right:20px;
    background:rgba(0,0,0,0.6); border-radius:12px; padding:12px 20px;
    box-shadow:0 0 15px rgba(0,0,0,0.4); text-align:center;
    font-size:16px; min-width:220px;
  }
  #header { cursor:move; font-weight:bold; margin-bottom:6px; }
  #widget:hover { background:rgba(0,0,0,0.8); }
  input { width:100%; padding:6px; margin-bottom:6px; border-radius:6px; border:none; }
  button { padding:6px 12px; border:none; border-radius:6px; background:#00b86b; color:white; cursor:pointer; }
  #nearest { margin-top:8px; font-weight:bold; }
</style>
</head>
<body>

<div id="widget">
  <div id="header">Skydive Widget</div>
  <input type="text" id="vrpidInput" placeholder="Your VRPid" tabindex="0">
  <input type="password" id="apiKeyInput" placeholder="Your Private API Key" tabindex="0">
  <button onclick="startWidget()">Start</button>
  <div id="nearest"></div>
</div>

<script>
const skydiveLocations = [
  {name:"Skydive Alpha", x:200, y:300, z:100},
  {name:"Skydive Beta", x:-1500, y:2500, z:100},
  {name:"Skydive Gamma", x:1000, y:-2000, z:100},
];

let vrpid, apiKey, updateInterval;

function startWidget(){
  vrpid = document.getElementById("vrpidInput").value.trim();
  apiKey = document.getElementById("apiKeyInput").value.trim();
  if(!vrpid || !apiKey) return alert("Enter VRPid and Private API Key");

  findNearest();
  updateInterval = setInterval(findNearest, 3000); // update every 3s
}

async function findNearest(){
  try{
    const url = `https://tycoon-2epova.users.cfx.re/status/map/positions.json?v=${Date.now()}`;
    const res = await fetch(url, {
      headers: { "X-Tycoon-Key": apiKey }
    });
    const data = await res.json();

    const player = data.players.find(p => p[2]==vrpid);
    if(!player) return document.getElementById("nearest").innerText = "Player not found";

    const pos = player[3]; // x, y, z
    let nearest = skydiveLocations[0];
    let minDist = distance(pos, nearest);
    for(const loc of skydiveLocations){
      const dist = distance(pos, loc);
      if(dist < minDist){ minDist=dist; nearest=loc; }
    }

    document.getElementById("nearest").innerText = `Nearest Skydive: ${nearest.name} (${Math.round(minDist)}m)`;

    // Set waypoint in-game
    if(window.setWaypoint) window.setWaypoint(nearest.x, nearest.y);

  }catch(err){
    console.error(err);
    document.getElementById("nearest").innerText = "Error fetching positions";
  }
}

function distance(a,b){
  return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2 + (a.z-b.z)**2);
}

// Make widget draggable only by header
dragElement(document.getElementById("widget"), document.getElementById("header"));
function dragElement(el, handle){
  let pos1=0,pos2=0,pos3=0,pos4=0;
  handle.onmousedown = dragMouseDown;
  function dragMouseDown(e){
    e=e||window.event; e.preventDefault();
    pos3=e.clientX; pos4=e.clientY;
    document.onmouseup=closeDragElement;
    document.onmousemove=elementDrag;
  }
  function elementDrag(e){
    e=e||window.event; e.preventDefault();
    pos1=pos3-e.clientX; pos2=pos4-e.clientY;
    pos3=e.clientX; pos4=e.clientY;
    el.style.top=(el.offsetTop-pos2)+"px";
    el.style.left=(el.offsetLeft-pos1)+"px";
  }
  function closeDragElement(){
    document.onmouseup=null;
    document.onmousemove=null;
  }
}
</script>
</body>
</html>
